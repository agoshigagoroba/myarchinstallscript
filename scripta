#!/bin/bash
set -e

# Verifica se o script está sendo executado como root
if [[ $EUID -ne 0 ]]; then
  echo "Este script deve ser executado como root."
  exit 1
fi

##########################
# Preparação do Sistema  #
##########################

# Instala o reflector, se não estiver instalado
echo "Instalando reflector..."
pacman -S --noconfirm reflector

# Atualiza os mirrors do Arch Linux
echo "Atualizando mirrors do Arch Linux..."
reflector --latest 10 --sort rate --save /etc/pacman.d/mirrorlist

# Atualiza o keyring e o sistema
echo "Atualizando keyring e sistema..."
pacman -Sy --noconfirm archlinux-keyring
pacman -Syu --noconfirm

# Configura o fuso horário para Recife
echo "Configurando fuso horário para Recife..."
ln -sf /usr/share/zoneinfo/America/Recife /etc/localtime
hwclock --systohc
timedatectl set-timezone America/Recife

# Configura o teclado ABNT2 (para console e ambiente gráfico)
echo "Configurando teclado (ABNT2)..."
echo "KEYMAP=br-abnt2" > /etc/vconsole.conf
localectl set-x11-keymap br abnt2

# Instala e ativa o NetworkManager
echo "Instalando e ativando NetworkManager..."
pacman -S --noconfirm networkmanager network-manager-applet
systemctl enable NetworkManager
systemctl start NetworkManager

# Instala PipeWire e componentes de áudio
echo "Instalando PipeWire e componentes de áudio..."
pacman -S --noconfirm pipewire pipewire-alsa pipewire-pulse pipewire-jack wireplumber pavucontrol

# Instala os kernels Linux padrão e Linux Zen
echo "Instalando kernels (linux e linux-zen)..."
pacman -S --noconfirm linux linux-headers linux-zen linux-zen-headers

# Detecta GPU e instala os drivers apropriados
echo "Detectando GPU e instalando drivers..."
GPU=$(lspci | grep -E "VGA|3D")
if echo "$GPU" | grep -qi "NVIDIA"; then
    echo "GPU NVIDIA detectada. Instalando drivers..."
    pacman -S --noconfirm nvidia nvidia-utils nvidia-dkms nvidia-settings
    sed -i '/^MODULES=/ s/)/ nvidia nvidia_modeset nvidia_uvm nvidia_drm)/' /etc/mkinitcpio.conf
elif echo "$GPU" | grep -qi "AMD"; then
    echo "GPU AMD detectada. Instalando drivers..."
    pacman -S --noconfirm mesa xf86-video-amdgpu vulkan-radeon
    sed -i '/^MODULES=/ s/)/ amdgpu)/' /etc/mkinitcpio.conf
elif echo "$GPU" | grep -qi "Intel"; then
    echo "GPU Intel detectada. Instalando drivers..."
    pacman -S --noconfirm mesa xf86-video-intel vulkan-intel
    sed -i '/^MODULES=/ s/)/ i915)/' /etc/mkinitcpio.conf
else
    echo "Nenhuma GPU conhecida detectada."
fi

# Atualiza o initramfs
echo "Atualizando initramfs..."
mkinitcpio -P

####################################
# Instalação do Ambiente Gráfico   #
####################################

# Instala o Plasma 6 com suporte a Wayland (sem o pacote kde-applications)
echo "Instalando KDE Plasma 6 com Wayland..."
pacman -S --noconfirm plasma-workspace plasma-meta qt5-wayland qt6-wayland

# Instala e configura o LightDM como display manager
echo "Instalando e configurando LightDM..."
pacman -S --noconfirm lightdm lightdm-gtk-greeter
# Configura o LightDM para usar a sessão Plasma Wayland por padrão:
if [ -f /etc/lightdm/lightdm.conf ]; then
    # Insere (ou substitui) a linha 'user-session=plasmawayland-session' na seção [Seat:*]
    sed -i '/^\[Seat:\*\]/,/^$/ s/^user-session=.*/user-session=plasmawayland-session/' /etc/lightdm/lightdm.conf || \
    sed -i '/^\[Seat:\*\]/a user-session=plasmawayland-session' /etc/lightdm/lightdm.conf
else
    cat <<EOF >/etc/lightdm/lightdm.conf
[Seat:*]
user-session=plasmawayland-session
EOF
fi
systemctl enable lightdm
systemctl start lightdm

##########################
# Instalação do Fish Shell#
##########################

echo "Instalando fish shell..."
pacman -S --noconfirm fish

#####################################################
# Criação Interativa do Usuário (Penúltima Etapa)    #
#####################################################

echo "=============================================="
echo "Criação interativa de usuário"
echo "=============================================="
read -rp "Informe o nome do usuário a ser criado: " username
# Cria o usuário com o fish como shell padrão
useradd -m -G wheel -s /usr/bin/fish "$username"
echo "Agora, defina a senha para o usuário $username:"
passwd "$username"
chown -R "$username":"$username" /home/"$username"
echo "$username ALL=(ALL) ALL" > /etc/sudoers.d/"$username"
echo "Usuário $username criado com sucesso!"
echo "=============================================="

#####################################################
# Configuração do Fish: Executa fastfetch no início  #
#####################################################

echo "Configurando fish para rodar fastfetch no startup..."
sudo -u "$username" bash -c 'mkdir -p ~/.config/fish; \
    if [ -f ~/.config/fish/config.fish ]; then \
      echo "fastfetch" | cat - ~/.config/fish/config.fish > ~/.config/fish/config.fish.new; \
      mv ~/.config/fish/config.fish.new ~/.config/fish/config.fish; \
    else \
      echo "fastfetch" > ~/.config/fish/config.fish; \
    fi'

#####################################################
# Instalação do yay e Pacotes Adicionais via yay     #
#####################################################

# Instala o yay (AUR helper) como o usuário recém-criado
echo "Instalando yay (AUR helper) para o usuário $username..."
sudo -u "$username" bash -c "cd ~ && git clone https://aur.archlinux.org/yay.git && cd yay && makepkg -si --noconfirm"

# Instala pacotes adicionais via yay:
echo "Instalando pacotes adicionais via yay para o usuário $username..."
sudo -u "$username" yay -S --noconfirm alacritty virtualbox-host-dkms open-vm-tools dolphin plasma-systemmonitor spectacle kdeconnect kfind firefox kmag kmix gparted fastfetch

echo "Instalação concluída! Reinicie o sistema para aplicar todas as mudanças."
